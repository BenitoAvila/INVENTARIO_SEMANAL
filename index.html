<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SISTEMA BENITO AVILA</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body{
    font-family: 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    margin:0;
    color:white;
}

.card{
    background: rgba(32, 58, 67, 0.95);
    backdrop-filter: blur(10px);
    padding:40px;
    border-radius:20px;
    width:400px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    animation: slideIn 0.5s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

h2{
    text-align:center;
    margin-bottom:30px;
    color:#fff;
    font-size:28px;
    text-transform:uppercase;
    letter-spacing:2px;
}

.input-group{
    margin-bottom:20px;
    position:relative;
}

.input-group label{
    display:block;
    margin-bottom:5px;
    color:#a8dadc;
    font-size:14px;
    font-weight:500;
}

input{
    width:100%;
    padding:12px 15px;
    margin:5px 0;
    border-radius:8px;
    border:2px solid transparent;
    background: rgba(255,255,255,0.1);
    color:white;
    font-size:16px;
    transition: all 0.3s;
}

input:focus{
    outline:none;
    border-color:#00c853;
    background: rgba(255,255,255,0.15);
}

input::placeholder{
    color: rgba(255,255,255,0.5);
}

.password-container{
    position:relative;
}

.toggle-password{
    position:absolute;
    right:15px;
    top:50%;
    transform:translateY(-50%);
    cursor:pointer;
    color: rgba(255,255,255,0.7);
    font-size:18px;
}

.toggle-password:hover{
    color:#00c853;
}

button{
    width:100%;
    padding:14px;
    margin:20px 0 10px;
    border-radius:8px;
    border:none;
    background:#00c853;
    color:white;
    font-weight:bold;
    cursor:pointer;
    font-size:16px;
    text-transform:uppercase;
    letter-spacing:1px;
    transition: all 0.3s;
    position:relative;
    overflow:hidden;
}

button:hover{
    background:#00a844;
    transform:translateY(-2px);
    box-shadow:0 10px 20px rgba(0,200,83,0.3);
}

button:active{
    transform:translateY(0);
}

button.loading{
    background:#2e7d32;
    pointer-events:none;
}

button.loading::after{
    content:"";
    position:absolute;
    width:20px;
    height:20px;
    top:50%;
    left:50%;
    margin-left:-10px;
    margin-top:-10px;
    border:3px solid rgba(255,255,255,0.3);
    border-top-color:white;
    border-radius:50%;
    animation: spin 1s infinite linear;
}

@keyframes spin{
    to{transform:rotate(360deg);}
}

.error{
    background: rgba(198, 40, 40, 0.2);
    color:#ff8a80;
    padding:12px;
    border-radius:8px;
    margin:15px 0;
    text-align:center;
    border-left:4px solid #c62828;
    font-size:14px;
    animation: shake 0.5s;
}

@keyframes shake{
    0%,100%{transform:translateX(0);}
    10%,30%,50%,70%,90%{transform:translateX(-5px);}
    20%,40%,60%,80%{transform:translateX(5px);}
}

.success{
    background: rgba(46, 125, 50, 0.2);
    color:#b9f6ca;
    padding:12px;
    border-radius:8px;
    margin:15px 0;
    text-align:center;
    border-left:4px solid #2e7d32;
}

.footer{
    text-align:center;
    margin-top:20px;
    color: rgba(255,255,255,0.5);
    font-size:12px;
}

.footer a{
    color:#00c853;
    text-decoration:none;
}

.footer a:hover{
    text-decoration:underline;
}

.version{
    position:absolute;
    bottom:10px;
    right:10px;
    color: rgba(255,255,255,0.3);
    font-size:11px;
}
</style>
</head>
<body>

<div class="card">
<h2>üîê SISTEMA BENITO AVILA</h2>

<div class="input-group">
    <label>Usuario</label>
    <input type="text" id="usuario" placeholder="Ingresa tu usuario" autocomplete="off">
</div>

<div class="input-group">
    <label>Contrase√±a</label>
    <div class="password-container">
        <input type="password" id="password" placeholder="Ingresa tu contrase√±a">
        <span class="toggle-password" onclick="togglePassword()">üëÅÔ∏è</span>
    </div>
</div>

<button onclick="login()" id="btnLogin">Ingresar</button>

<div id="mensaje"></div>

<div class="footer">
    ¬© 2026 ControlStock BA<br>
    <small>v2.0</small>
</div>
</div>

<script>
// ============================================
// CONFIGURACI√ìN FIREBASE
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBeg5PzCkaf98mmWiXrr6wpu8v-iWDj0t4",
    authDomain: "inventario-eurofert.firebaseapp.com",
    databaseURL: "https://inventario-eurofert-default-rtdb.firebaseio.com",
    projectId: "inventario-eurofert",
    storageBucket: "inventario-eurofert.firebasestorage.app",
    messagingSenderId: "786796692081",
    appId: "1:786796692081:web:c742cfbd1d23c3347f91d0"
};

// Limpiar sesi√≥n al cargar login
localStorage.clear();

// Inicializar Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

// ============================================
// VARIABLES GLOBALES
// ============================================
let isLoading = false;

// ============================================
// FUNCIONES DE UTILIDAD
// ============================================
function togglePassword() {
    let passwordInput = document.getElementById("password");
    let toggleBtn = event.currentTarget;
    
    if(passwordInput.type === "password") {
        passwordInput.type = "text";
        toggleBtn.textContent = "üîí";
    } else {
        passwordInput.type = "password";
        toggleBtn.textContent = "üëÅÔ∏è";
    }
}

function mostrarMensaje(texto, tipo) {
    let mensajeDiv = document.getElementById("mensaje");
    mensajeDiv.className = tipo;
    mensajeDiv.innerHTML = texto;
    
    setTimeout(() => {
        mensajeDiv.innerHTML = "";
        mensajeDiv.className = "";
    }, 5000);
}

function validarUsuario(usuario) {
    if (!usuario || usuario.trim() === "") {
        return false;
    }
    // Evitar caracteres que puedan causar problemas en Firebase
    // No permitir: . $ # [ ] / 
    let caracteresProhibidos = /[.$#\[\]\/]/;
    return !caracteresProhibidos.test(usuario);
}

function validarPassword(password) {
    return password.length >= 4;
}

// ============================================
// FUNCI√ìN PRINCIPAL DE LOGIN
// ============================================
async function login() {
    if(isLoading) return;
    
    let usuario = document.getElementById("usuario").value.trim();
    let password = document.getElementById("password").value.trim();
    let btnLogin = document.getElementById("btnLogin");
    
    document.getElementById("mensaje").innerHTML = "";
    
    // Validaciones b√°sicas
    if(usuario === "" || password === "") {
        mostrarMensaje("‚ùå Complete todos los campos", "error");
        return;
    }
    
    if(!validarUsuario(usuario)) {
        mostrarMensaje("‚ùå Usuario contiene caracteres no permitidos (. $ # [ ] /)", "error");
        return;
    }
    
    if(!validarPassword(password)) {
        mostrarMensaje("‚ùå La contrase√±a debe tener al menos 4 caracteres", "error");
        return;
    }
    
    // Mostrar estado de carga
    isLoading = true;
    btnLogin.classList.add("loading");
    btnLogin.textContent = "";
    
    try {
        console.log("üîç Buscando usuario:", usuario);
        
        // Buscar usuario en Firebase
        const snapshot = await db.ref("usuarios/" + usuario).once("value");
        
        if(!snapshot.exists()) {
            console.log("‚ùå Usuario no encontrado");
            mostrarMensaje("‚ùå Usuario no registrado en el sistema", "error");
            isLoading = false;
            btnLogin.classList.remove("loading");
            btnLogin.textContent = "Ingresar";
            return;
        }
        
        let data = snapshot.val();
        console.log("‚úÖ Usuario encontrado");
        
        // Verificar si la cuenta est√° bloqueada
        if(data.bloqueadoHasta) {
            let fechaBloqueo = new Date(data.bloqueadoHasta);
            let ahora = new Date();
            
            if(fechaBloqueo > ahora) {
                let minutosRestantes = Math.ceil((fechaBloqueo - ahora) / 60000);
                mostrarMensaje(`‚è≥ Cuenta bloqueada. Intenta en ${minutosRestantes} minutos`, "error");
                isLoading = false;
                btnLogin.classList.remove("loading");
                btnLogin.textContent = "Ingresar";
                return;
            }
        }
        
        // Verificar contrase√±a
        if(data.password !== password) {
            console.log("‚ùå Contrase√±a incorrecta");
            
            // Registrar intento fallido
            let intentos = (data.intentosFallidos || 0) + 1;
            let updates = {};
            updates["/usuarios/" + usuario + "/intentosFallidos"] = intentos;
            
            // Bloquear despu√©s de 3 intentos fallidos
            if(intentos >= 3) {
                let bloqueoHasta = new Date();
                bloqueoHasta.setMinutes(bloqueoHasta.getMinutes() + 5);
                updates["/usuarios/" + usuario + "/bloqueadoHasta"] = bloqueoHasta.toISOString();
                updates["/usuarios/" + usuario + "/intentosFallidos"] = 0;
                
                await db.ref().update(updates);
                mostrarMensaje("‚è≥ Demasiados intentos. Bloqueado 5 minutos", "error");
            } else {
                await db.ref().update(updates);
                mostrarMensaje(`‚ùå Contrase√±a incorrecta (Intento ${intentos}/3)`, "error");
            }
            
            isLoading = false;
            btnLogin.classList.remove("loading");
            btnLogin.textContent = "Ingresar";
            return;
        }
        
        // Login exitoso
        console.log("‚úÖ Login exitoso!");
        
        // Resetear intentos fallidos
        await db.ref("usuarios/" + usuario).update({
            intentosFallidos: 0,
            bloqueadoHasta: null,
            ultimoAcceso: new Date().toISOString()
        });
        
        // Guardar sesi√≥n
        localStorage.setItem("usuario", usuario);
        localStorage.setItem("rol", data.rol);
        localStorage.setItem("ultimoAcceso", new Date().toISOString());
        localStorage.setItem("ultimoUsuario", usuario); // Recordar √∫ltimo usuario
        
        mostrarMensaje("‚úÖ Acceso correcto! Redirigiendo...", "success");
        
        // Redirigir seg√∫n rol
        setTimeout(() => {
            if(data.rol === "admin") {
                window.location.href = "admin.html";
            } else {
                window.location.href = "panel.html";
            }
        }, 1000);
        
    } catch(err) {
        console.error("‚ùå Error de conexi√≥n:", err);
        mostrarMensaje("‚ùå Error de conexi√≥n con el servidor", "error");
        
        isLoading = false;
        btnLogin.classList.remove("loading");
        btnLogin.textContent = "Ingresar";
    }
}

// ============================================
// EVENTOS E INICIALIZACI√ìN
// ============================================
document.getElementById("usuario").addEventListener("keypress", function(e) {
    if(e.key === "Enter") login();
});

document.getElementById("password").addEventListener("keypress", function(e) {
    if(e.key === "Enter") login();
});

window.onload = function() {
    document.getElementById("usuario").focus();
    
    // Cargar √∫ltimo usuario si existe
    let ultimoUsuario = localStorage.getItem("ultimoUsuario");
    if(ultimoUsuario) {
        document.getElementById("usuario").value = ultimoUsuario;
        document.getElementById("password").focus();
    }
    
    console.log("‚úÖ Firebase inicializado:", firebase.apps.length > 0);
};
</script>

</body>
</html>