<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Panel Colaborador - Inventario</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body{
font-family:Arial;
background:#1e3c72;
color:white;
padding:20px;
}
.card{
background:#203a43;
padding:20px;
border-radius:12px;
margin-bottom:20px;
}
select,input,button{
width:100%;
padding:10px;
margin:8px 0;
border-radius:6px;
border:none;
}
button{
background:#00c853;
color:white;
font-weight:bold;
cursor:pointer;
}
button:hover{
opacity:0.9;
}
.ok{
background:#2e7d32;
padding:8px;
border-radius:6px;
margin-top:10px;
}
.error{
background:#c62828;
padding:8px;
border-radius:6px;
margin-top:10px;
}
</style>
</head>
<body>

<h2>üì¶ Panel Colaborador - Inventario</h2>

<button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>

<div class="card">

<label>Seleccione Producto</label>
<select id="productoSelect">
<option value="">Cargando productos...</option>
</select>

<input type="number" id="fisico" placeholder="Cantidad F√≠sica Buen Estado">
<input type="number" id="muestras" placeholder="Muestras / Promociones">
<input type="number" id="caducados" placeholder="Caducados">

<button onclick="guardar()">Enviar Inventario</button>

<div id="estado"></div>

</div>

<script>

// üîí VALIDAR SESI√ìN
if(!localStorage.getItem("usuario")){
alert("Debe iniciar sesi√≥n");
window.location="index.html";
}

// üî• FIREBASE CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyBeg5PzCkaf98mmWiXrr6wpu8v-iWDj0t4",
    authDomain: "inventario-eurofert.firebaseapp.com",
    databaseURL: "https://inventario-eurofert-default-rtdb.firebaseio.com",
    projectId: "inventario-eurofert",
    storageBucket: "inventario-eurofert.firebasestorage.app",
    messagingSenderId: "786796692081",
    appId: "1:786796692081:web:c742cfbd1d23c3347f91d0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// üîπ Cerrar sesi√≥n
function cerrarSesion(){
localStorage.clear();
window.location="index.html";
}

// üîπ Cargar productos
let usuario=localStorage.getItem("usuario");

db.ref("asignaciones/"+usuario).once("value").then(snapshot=>{

if(!snapshot.exists()){
document.getElementById("productoSelect").innerHTML="<option>No tiene productos asignados</option>";
return;
}

let productosAsignados=snapshot.val();

db.ref("productos").once("value").then(prodSnap=>{

let select=document.getElementById("productoSelect");
select.innerHTML="";

prodSnap.forEach(child=>{
let id=child.key;

if(productosAsignados[id]){

let data=child.val();

let option=document.createElement("option");
option.value=data.nombre;
option.text=data.nombre+" (Sistema: "+data.sistema+")";
option.setAttribute("data-sistema",data.sistema);

select.appendChild(option);

}

});

});

});

// üîπ Guardar inventario
function guardar(){

let estado=document.getElementById("estado");
estado.innerHTML="";

let nombreColaborador=localStorage.getItem("usuario");

if(!nombreColaborador){
estado.innerHTML='<div class="error">Sesi√≥n no v√°lida. Vuelva a iniciar sesi√≥n.</div>';
return;
}

let select=document.getElementById("productoSelect");

if(select.value===""){
estado.innerHTML='<div class="error">Seleccione producto</div>';
return;
}

let producto=select.value;
let sistema=parseInt(select.selectedOptions[0].getAttribute("data-sistema"));

let fisico=parseInt(document.getElementById("fisico").value)||0;
let muestras=parseInt(document.getElementById("muestras").value)||0;
let caducados=parseInt(document.getElementById("caducados").value)||0;

let total=fisico+muestras+caducados;

// üîé Validar que cuadre
if(total!==sistema){
estado.innerHTML='<div class="error">‚ùå Inventario no cuadra</div>';
return;
}

// üìÖ Guardar por mes
let fechaISO=new Date().toISOString();
let mes=fechaISO.substring(0,7);

db.ref("inventario/"+mes).push({
fecha:fechaISO,
nombre:nombreColaborador,
producto:producto,
sistema:sistema,
fisico:fisico,
muestras:muestras,
caducados:caducados
})
.then(()=>{

estado.innerHTML='<div class="ok">‚úÖ Inventario enviado correctamente</div>';

document.getElementById("fisico").value="";
document.getElementById("muestras").value="";
document.getElementById("caducados").value="";

})
.catch(error=>{
estado.innerHTML='<div class="error">Error al guardar: '+error.message+'</div>';
});

}

</script>

</body>
</html>