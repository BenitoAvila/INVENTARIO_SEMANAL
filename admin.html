<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Panel Administrador</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body{
font-family:Arial;
background:#1e3c72;
color:white;
padding:20px;
}
.card{
background:#203a43;
padding:20px;
border-radius:12px;
margin-bottom:20px;
}
input,select,button{
width:100%;
padding:10px;
margin:8px 0;
border-radius:6px;
border:none;
}
button{
background:#00c853;
color:white;
font-weight:bold;
cursor:pointer;
}
button:hover{
opacity:0.9;
}
.producto{
background:#1c2b33;
padding:10px;
margin:8px 0;
border-radius:8px;
cursor:pointer;
}
.registro{
background:#102027;
padding:10px;
margin:6px 0;
border-radius:6px;
}
.fechaBox{
background:#1565c0;
padding:6px;
margin-top:10px;
border-radius:6px;
}
.eliminar{
background:#c62828;
margin-top:5px;
}
</style>
</head>
<body>

<script>
// Validar sesiÃ³n admin
if(localStorage.getItem("rol")!=="admin"){
alert("Acceso solo administrador");
window.location="login.html";
}
</script>

<h2>ðŸ‘‘ Panel Administrador</h2>

<button onclick="cerrarSesion()">Cerrar SesiÃ³n</button>

<!-- Crear Producto -->
<div class="card">
<h3>Crear Producto</h3>
<input type="text" id="nombreProducto" placeholder="Nombre Producto">
<input type="number" id="cantidadSistema" placeholder="Cantidad Sistema">
<button onclick="crearProducto()">Guardar Producto</button>
</div>

<!-- Filtro Mes -->
<div class="card">
<h3>Filtrar por Mes</h3>
<input type="month" id="filtroMes">
<button onclick="aplicarFiltro()">Aplicar Filtro</button>
<button onclick="exportarExcel()">Exportar Excel</button>
</div>

<!-- Lista Productos -->
<div class="card">
<h3>Productos Registrados</h3>
<div id="listaProductos"></div>
</div>

<script>

const firebaseConfig = {
apiKey: "AIzaSyBeg5PzCkaf98mmWiXrr6wpu8v-iWDj0t4",
authDomain: "inventario-eurofert.firebaseapp.com",
databaseURL: "https://inventario-eurofert-default-rtdb.firebaseio.com",
projectId: "inventario-eurofert",
storageBucket: "inventario-eurofert.firebasestorage.app",
messagingSenderId: "786796692081",
appId: "1:786796692081:web:c742cfbd1d23c3347f91d0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let filtroMesSeleccionado = null;

// Cerrar sesiÃ³n
function cerrarSesion(){
localStorage.clear();
window.location="login.html";
}

// Crear producto
function crearProducto(){
let nombre=document.getElementById("nombreProducto").value;
let sistema=parseInt(document.getElementById("cantidadSistema").value);

if(!nombre || !sistema){
alert("Complete los campos");
return;
}

db.ref("productos").push({
nombre:nombre,
sistema:sistema
});

document.getElementById("nombreProducto").value="";
document.getElementById("cantidadSistema").value="";
}

// Cargar productos
db.ref("productos").on("value", snapshot=>{

let contenedor=document.getElementById("listaProductos");
contenedor.innerHTML="";

snapshot.forEach(child=>{
let data=child.val();
let key=child.key;

contenedor.innerHTML+=`
<div class="producto" onclick="toggleProducto('${data.nombre}')">
ðŸ“¦ ${data.nombre} (Sistema: ${data.sistema})
</div>
<div id="registros-${data.nombre}" style="display:none;"></div>
`;
});

});

// Toggle producto
function toggleProducto(nombreProducto){

let contenedor=document.getElementById("registros-"+nombreProducto);

if(contenedor.style.display==="block"){
contenedor.style.display="none";
return;
}

contenedor.style.display="block";
contenedor.innerHTML="Cargando...";

let mesConsulta = filtroMesSeleccionado || new Date().toISOString().substring(0,7);

db.ref("inventario/"+mesConsulta).once("value", snapshot=>{

if(!snapshot.exists()){
contenedor.innerHTML="<p>No hay registros este mes.</p>";
return;
}

let datosPorFecha={};

snapshot.forEach(child=>{
let data=child.val();
let key=child.key;

if(data.producto===nombreProducto){

let fechaISO=data.fecha;
let fecha=fechaISO.split("T")[0];
let hora=new Date(fechaISO).toLocaleTimeString();

if(!datosPorFecha[fecha]){
datosPorFecha[fecha]=[];
}

datosPorFecha[fecha].push({
...data,
id:key,
hora:hora
});

}
});

contenedor.innerHTML="";

Object.keys(datosPorFecha).sort().reverse().forEach(fecha=>{

contenedor.innerHTML+=`
<div class="fechaBox">ðŸ“… ${fecha}</div>
`;

datosPorFecha[fecha].forEach(registro=>{

contenedor.innerHTML+=`
<div class="registro">
ðŸ‘¤ ${registro.nombre}<br>
ðŸ•’ ${registro.hora}<br>
Sistema: ${registro.sistema}<br>
FÃ­sico: ${registro.fisico}<br>
Muestras: ${registro.muestras}<br>
Caducados: ${registro.caducados}
<button class="eliminar" onclick="eliminarRegistro('${mesConsulta}','${registro.id}')">Eliminar</button>
</div>
`;

});

});

});

}

// Eliminar registro
function eliminarRegistro(mes,id){
if(confirm("Â¿Eliminar registro?")){
db.ref("inventario/"+mes+"/"+id).remove();
}
}

// Filtro mes
function aplicarFiltro(){
filtroMesSeleccionado=document.getElementById("filtroMes").value;
alert("Filtro aplicado");
}

// Exportar Excel
function exportarExcel(){

let mesConsulta = filtroMesSeleccionado || new Date().toISOString().substring(0,7);

db.ref("inventario/"+mesConsulta).once("value", snapshot=>{

if(!snapshot.exists()){
alert("No hay datos");
return;
}

let csv="Fecha,Hora,Nombre,Producto,Sistema,Fisico,Muestras,Caducados\n";

snapshot.forEach(child=>{
let d=child.val();
let fecha=d.fecha.split("T")[0];
let hora=new Date(d.fecha).toLocaleTimeString();

csv+=`${fecha},${hora},${d.nombre},${d.producto},${d.sistema},${d.fisico},${d.muestras},${d.caducados}\n`;
});

let blob=new Blob([csv],{type:"text/csv"});
let link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="inventario_"+mesConsulta+".csv";
link.click();

});

}

</script>

</body>
</html>