<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Panel Administrador</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
body{
font-family:Arial;
background:#1e3c72;
color:white;
padding:20px;
}
.card{
background:#203a43;
padding:20px;
border-radius:12px;
margin-bottom:20px;
}
input,button,select{
width:100%;
padding:10px;
margin:8px 0;
border-radius:6px;
border:none;
}
button{
background:#00c853;
color:white;
font-weight:bold;
cursor:pointer;
}
.producto{
background:#1c2b33;
padding:12px;
margin:6px 0;
border-radius:8px;
cursor:pointer;
}
.producto:hover{
background:#294c5a;
}
.registrosProducto{
display:none;
margin-top:10px;
}
.registro{
background:#102a43;
padding:8px;
margin:5px 0;
border-radius:6px;
}
.fechaBox{
background:#0f3057;
padding:8px;
margin-top:10px;
border-radius:6px;
}
.eliminarBtn{ background:#c62828; }
.eliminarTodoBtn{ background:#ff6f00; margin-top:10px; }
.filtroMes{ background:#102a43; padding:10px; border-radius:8px; margin-bottom:15px; }
</style>
</head>
<body>

<h2>ðŸ‘‘ Panel Administrador</h2>

<button onclick="cerrarSesion()">Cerrar SesiÃ³n</button>

<!-- CREAR USUARIO -->
<div class="card">
<h3>ðŸ‘¤ Crear Usuario</h3>
<input type="text" id="nuevoUsuario" placeholder="Nombre usuario">
<input type="password" id="nuevoPassword" placeholder="ContraseÃ±a">
<select id="rolUsuario">
<option value="colaborador">Colaborador</option>
<option value="admin">Administrador</option>
</select>
<button onclick="crearUsuario()">Crear Usuario</button>
</div>

<!-- CREAR PRODUCTO -->
<div class="card">
<h3>âž• Crear Producto</h3>
<input type="text" id="nombreProducto" placeholder="Nombre producto">
<input type="number" id="cantidadSistema" placeholder="Cantidad Sistema">
<button onclick="crearProducto()">Guardar Producto</button>
</div>

<!-- FILTRO MES -->
<div class="card filtroMes">
<h3>ðŸ“… Filtro por Mes</h3>
<input type="month" id="mesFiltro">
<button onclick="aplicarFiltro()">Aplicar Filtro</button>
<button onclick="limpiarFiltro()">Ver Todo</button>
</div>

<!-- LISTA PRODUCTOS -->
<div class="card">
<h3>ðŸ“¦ Productos (Click para ver registros)</h3>
<div id="listaProductos"></div>
</div>

<script>

// ðŸ”’ PROTEGER ACCESO SOLO ADMIN
if(localStorage.getItem("rol") !== "admin"){
alert("Acceso denegado");
window.location="login.html";
}

// ðŸ”¥ FIREBASE CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyBeg5PzCkaf98mmWiXrr6wpu8v-iWDj0t4",
    authDomain: "inventario-eurofert.firebaseapp.com",
    databaseURL: "https://inventario-eurofert-default-rtdb.firebaseio.com",
    projectId: "inventario-eurofert",
    storageBucket: "inventario-eurofert.firebasestorage.app",
    messagingSenderId: "786796692081",
    appId: "1:786796692081:web:c742cfbd1d23c3347f91d0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let filtroMesSeleccionado = null;

// ðŸ”¹ CERRAR SESIÃ“N
function cerrarSesion(){
localStorage.clear();
window.location="login.html";
}

// ðŸ”¹ CREAR USUARIO
function crearUsuario(){
let usuario = document.getElementById("nuevoUsuario").value;
let password = document.getElementById("nuevoPassword").value;
let rol = document.getElementById("rolUsuario").value;

if(usuario==="" || password===""){
alert("Complete los campos");
return;
}

db.ref("usuarios/" + usuario).set({
password: password,
rol: rol
});

alert("Usuario creado correctamente");

document.getElementById("nuevoUsuario").value="";
document.getElementById("nuevoPassword").value="";
}

// ðŸ”¹ CREAR PRODUCTO
function crearProducto(){
let nombre = document.getElementById("nombreProducto").value;
let sistema = parseInt(document.getElementById("cantidadSistema").value) || 0;

if(nombre===""){
alert("Ingrese nombre producto");
return;
}

db.ref("productos").push({
nombre:nombre,
sistema:sistema
});

document.getElementById("nombreProducto").value="";
document.getElementById("cantidadSistema").value="";
}

// ðŸ”¹ MOSTRAR PRODUCTOS
db.ref("productos").on("value", snapshot=>{
let lista=document.getElementById("listaProductos");
lista.innerHTML="";
snapshot.forEach(child=>{
let data=child.val();
lista.innerHTML+=`
<div class="producto" onclick="toggleProducto('${data.nombre}')">
ðŸ“¦ ${data.nombre} - Sistema: ${data.sistema}
<div id="registros-${data.nombre}" class="registrosProducto"></div>
</div>
`;
});
});

// ðŸ”¹ FILTRO MES
function aplicarFiltro(){
filtroMesSeleccionado=document.getElementById("mesFiltro").value;
alert("Filtro aplicado");
}
function limpiarFiltro(){
filtroMesSeleccionado=null;
document.getElementById("mesFiltro").value="";
}

// ðŸ”¹ MOSTRAR REGISTROS
function toggleProducto(nombreProducto){

let contenedor=document.getElementById("registros-"+nombreProducto);

if(contenedor.style.display==="block"){
contenedor.style.display="none";
return;
}

contenedor.style.display="block";
contenedor.innerHTML="Cargando...";

db.ref("inventario").once("value", snapshot=>{

let datosPorFecha={};

snapshot.forEach(child=>{
let data=child.val();
let key=child.key;

if(data.producto===nombreProducto){

let fechaISO=data.fecha;
let mesRegistro=fechaISO.substring(0,7);

if(filtroMesSeleccionado && mesRegistro!==filtroMesSeleccionado){
return;
}

let fecha=fechaISO.split("T")[0];
let hora=new Date(fechaISO).toLocaleTimeString();

if(!datosPorFecha[fecha]){
datosPorFecha[fecha]=[];
}

datosPorFecha[fecha].push({...data,id:key,hora:hora});
}
});

contenedor.innerHTML="";

Object.keys(datosPorFecha).sort().reverse().forEach(fecha=>{

contenedor.innerHTML+=`
<div class="fechaBox">ðŸ“… ${fecha}</div>
`;

datosPorFecha[fecha].forEach(registro=>{

contenedor.innerHTML+=`
<div class="registro">
ðŸ‘¤ ${registro.nombre}<br>
ðŸ•’ ${registro.hora}<br>
Sistema: ${registro.sistema}<br>
FÃ­sico: ${registro.fisico}<br>
Muestras: ${registro.muestras}<br>
Caducados: ${registro.caducados}<br><br>
<button class="eliminarBtn" onclick="eliminarRegistro('${registro.id}')">ðŸ—‘ Eliminar</button>
</div>
`;

});

});

});

}

// ðŸ”¹ ELIMINAR REGISTRO
function eliminarRegistro(id){
if(!confirm("Â¿Eliminar registro?")) return;
db.ref("inventario/"+id).remove();
}

</script>

</body>
</html>